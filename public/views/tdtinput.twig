<!--
    Form for testing a mapping file
    @copyright (C) 2013 by OKFN Belgium
    @license AGPLv3
    @author Leen De Baets
    @author Jeppe Knockaert
    @author Nicolas Dierck
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        {{ include('header.twig') }}
    </head>
    <body>
        {{ include('navbar.twig') }}
        <div class="container">
            <form action="#" method="post" {{form_enctype(form)}}>
                {% form_theme form 'formtemplate.twig' %}
                {{ form_widget(form) }}
            </form>
            <br />
            <textarea id="result"></textarea><br />
            <div id="error" style="display:none; color:red; font-style: italic"></div><br />

            <button id="submit1" class="btn">Map</button><br />
            <a href="{{relpath}}addjob">Add job</a>
        </div>
    <script>
        $(function(){  
            var editor = document.getElementById("mapping");

            $("#submit1").click(function(){
                var extract = {};
                switch($("#form_format").val()){
                    case "CSV0":
                    extract = {
                    "type": "CSV",
                    "delimiter": ";",
                    "has_header_row": "1"
                    }
                    break;
                    case "CSV1":
                    extract = {
                    "type": "CSV",
                    "delimiter": ",",
                    "has_header_row": "1"
                    }
                    break;
                    case "CSV2":
                    extract = {
                    "type": "CSV",
                    "delimiter": ";",
                    "has_header_row": "0"
                    }
                    break;  
                    case "CSV3":
                    extract = {
                    "type": "CSV",
                    "delimiter": ",",
                    "has_header_row": "0"
                    }
                    break;
                    case "JSON":
                    extract = {
                    "type": "JSON"
                    }
                    break;

                    case "XML":
                    extract = {
                    "type": "XML"
                    }
                    break;
                    default:
                }           

                var config = {
                    "mapping": $('#form_mapping').val(),
                    "extract": extract,
                    "chunk": $('#form_input').val()
                };
                $.ajax({
                    type: "POST",
                    url: "{{hostname}}tdtinput/test",
                    data: JSON.stringify(config),
                    success: function(data, status){
                        $("#error").hide();
                        $("#result").val(data);
                    },
                    error : function(data){
                        $("#error").html("Error "+data.status+": "+data.statusText).show();
                    }
                });
            });
        });
    </script>
    </body>
</html>